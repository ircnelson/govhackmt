<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Maps</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.4.1/css/bootstrap-slider.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #eeeeee;
        }
        .top{
            margin-top: 30px;
        }
        #map {
            height: 100%;
        }

        #ex1Slider .slider-selection {
            background: #BABABA;
        }
    </style>
</head>

<body>
    <div class="col-md-3" align="center">
        <div class="top"></div>
        <div class="form-group">
            <button onclick="toggleHeatmap()" class="btn btn-primary">Mostrar/Esconder Mapa </button>
        </div>

        <div class="form-group">
            <label>Selecione a categoria desejada:</label>
            <input id="ex1" 
                data-slider-id='ex1Slider' 
                type="text" 
                data-slider-min="0" 
                data-slider-max="20" 
                data-slider-step="1" 
                data-slider-value="14"
            />
        </div>  

        <div class="form-group">
            <label>Selecione a categoria desejada:</label>
            <select class="form-control selectBairros" id="selectBairros1">
                <option value="">Selecione...</option>
            </select>
        </div>
        <div class="form-group">
            <label>Selecione a categoria desejada:</label>
            <select class="form-control selectBairros" id="selectBairros2">
                <option value="">Selecione...</option>
            </select>
        </div>

        <div class="form-group">
            <h3><b>Ranking de bairros</b></h3>
            <div id="top10"></div>
        </div>

    </div>
    <div id="map"></div>    
    
    <script
        src="https://code.jquery.com/jquery-3.1.1.min.js"
        integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
        crossorigin="anonymous">
    </script>

    <script 
        src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" 
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" 
        crossorigin="anonymous">    
    </script>

    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.4.1/bootstrap-slider.min.js">
    </script>

    <script>

        $(document).ready(function(){
            $('#ex1').slider({
                formatter: function(value) {
                    return 'Valor Atual: ' + value;
                }
            });

            var bairrosAgrupados =  'http://felipefontana.com.br:3000/bairros/agrupados';

            $.get(bairrosAgrupados, function(data) {
                var option = '';
                var top10 = '<table width="100%">';

                for (var i = 0; i < data.length; i++) {
                    option += '<option value="'+ data[i]._id + '">' + data[i]._id + '</option>';
                }

                for (var i = 0; i < 10; i++) {
                    top10 += '<tr><td>'+ data[i]._id +'</td> <td><span style="color:red">'+ data[i].count +'</span></td></tr>'
                }
                top10 += '</table>';

                $('#top10').html(top10);

                $('.selectBairros').append(option);

            });

            $('.selectBairros').on('change', function(){

                var selectBairros1 = $('#selectBairros1').val();
                var selectBairros2 = $('#selectBairros2').val();

                if(selectBairros1 && selectBairros2){
                    var bairrosDetail =  'http://felipefontana.com.br:3000/bairros/'+ selectBairros1 +','+ selectBairros2;

                    var arrayPoints= [];

                    $.get(bairrosDetail, function(data) {
                        
                        for (var i = 0; i < data.length; i++) {
                            arrayPoints.push(new google.maps.LatLng(data[i].POINTS.lat, data[i].POINTS.lng));
                        }

                        heatmap.setMap(null);

                        heatmap = new google.maps.visualization.HeatmapLayer({
                            data: arrayPoints,
                            map: map,
                            maxIntensity: 5,
                        });
                        
                    });
                }
            });
        });

        var map, heatmap;

        function initMap() {

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: {lat: -15.587909, lng: -56.111856},
                mapTypeId: google.maps.MapTypeId.MAP
            });

            getPoints(function (data) {
                heatmap = new google.maps.visualization.HeatmapLayer({
                    data: data,
                    map: map,
                    maxIntensity: 5,
                });
            });
        }

        function toggleHeatmap() {
            heatmap.setMap(heatmap.getMap() ? null : map);
        }

        function getPoints(cb) {
            var arrayPoints= [];

            var url = 'http://felipefontana.com.br:3000/bairros';

            $.get(url, function(data) {
                for (var i = 0; i < data.length; i++) {
                    arrayPoints.push(new google.maps.LatLng(data[i].POINTS.lat, data[i].POINTS.lng));
                }

                cb(arrayPoints);
            });
        }
        
    </script>
   
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBKX6aJncPUImvj4wLQTpn79sE1nfVw5Ms&&libraries=visualization&callback=initMap">
    </script>
</body>
</html>
